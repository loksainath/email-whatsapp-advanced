<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email â†’ WhatsApp Dashboard</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<button class="toggle" onclick="toggleDark()">ğŸŒ™</button>

<h1>ğŸ“Š Email â†’ WhatsApp Automation Dashboard</h1>

<div class="cards">
    <div class="card" id="emails"></div>
    <div class="card" id="whatsapp"></div>
    <div class="card" id="replies"></div>
    <div class="card" id="spam"></div>
</div>

<a href="/download/logs">
    <button>â¬‡ Download CSV</button>
</a>

<h2>ğŸ“§ Email Logs</h2>
<table id="emailTable">
    <thead>
        <tr>
            <th>From</th>
            <th>Subject</th>
            <th>Priority</th>
            <th>Status</th>
            <th>Time</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<h2>ğŸ“ˆ Analytics</h2>
<div class="chart-container">
    <canvas id="emailChart"></canvas>
</div>

<script src="{{ url_for('static', filename='charts.js') }}"></script>
<script src="{{ url_for('static', filename='logs.js') }}"></script>

<script>
function toggleDark() {
    document.body.classList.toggle("dark");
}
</script>

</body>
</html> -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Email â†’ WhatsApp Automation Dashboard</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>

  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: #f5f7fb;
      margin: 0;
      padding: 20px;
      transition: background 0.3s, color 0.3s;
    }

    h1 { margin-bottom: 20px; }

    button {
      padding: 8px 12px;
      margin: 5px 0;
      cursor: pointer;
    }

    /* ===== Cards ===== */
    .cards {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

    .card h3 { margin: 0; font-size: 14px; color: #555; }
    .card p { font-size: 28px; margin: 10px 0 0; font-weight: bold; }

    /* ===== Table ===== */
    .table-container {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      margin-bottom: 30px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #222;
      color: white;
    }

    th, td {
      padding: 10px;
      text-align: left;
      font-size: 14px;
    }

    tbody tr:nth-child(even) { background: #f2f2f2; }

    .status { font-weight: bold; }
    .Queued { color: orange; }
    .Sent { color: green; }
    .Failed { color: red; }
    .Spam { color: gray; }

    /* ===== Analytics ===== */
    .analytics {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      margin-bottom: 30px;
    }

    /* ===== Dark Mode ===== */
    .dark {
      background: #121212;
      color: #e0e0e0;
    }

    .dark .card,
    .dark .table-container,
    .dark .analytics {
      background: #1e1e1e;
      color: #e0e0e0;
    }

    .dark thead { background: #333; }
  </style>
</head>

<body>

<button onclick="toggleDarkMode()">ğŸŒ™ Toggle Dark Mode</button>

<h1>ğŸ“§ Email â†’ WhatsApp Automation Dashboard</h1>

<!-- ===== Summary Cards ===== -->
<div class="cards">
  <div class="card"><h3>ğŸ“¨ Emails</h3><p id="totalEmails">0</p></div>
  <div class="card"><h3>â³ Queued</h3><p id="queuedCount">0</p></div>
  <div class="card"><h3>â†©ï¸ Replies</h3><p id="replyCount">0</p></div>
  <div class="card"><h3>ğŸ”´ Low Priority</h3><p id="lowPriority">0</p></div>
</div>

<!-- ===== Email Logs ===== -->
<div class="table-container">
  <h2>ğŸ“„ Email Logs</h2>

  <input
    type="text"
    id="searchBox"
    placeholder="ğŸ” Search sender / subject"
    onkeyup="updateUI()"
    style="margin-bottom:10px; padding:8px; width:300px;"
  />

  <br>
  <button onclick="downloadCSV()">â¬‡ Download CSV</button>

  <table>
    <thead>
      <tr>
        <th>From</th>
        <th>Subject</th>
        <th>Priority</th>
        <th>Status</th>
        <th>Time</th>
      </tr>
    </thead>
    <tbody id="emailTable"></tbody>
  </table>
</div>

<!-- ===== Analytics ===== -->
<div class="analytics">
  <h2>ğŸ“ˆ Analytics</h2>
  <canvas id="priorityChart" height="100"></canvas>
  <br><br>
  <canvas id="timeChart" height="120"></canvas>
</div>

<script>
const socket = io();

let emails = [];
let priorityCount = { HIGH: 0, MEDIUM: 0, LOW: 0 };

/* ===== Charts ===== */
const priorityChart = new Chart(
  document.getElementById("priorityChart"),
  {
    type: "bar",
    data: {
      labels: ["HIGH", "MEDIUM", "LOW"],
      datasets: [{
        label: "Email Priority",
        data: [0, 0, 0],
        backgroundColor: ["red", "orange", "blue"]
      }]
    }
  }
);

const timeChart = new Chart(
  document.getElementById("timeChart"),
  {
    type: "line",
    data: {
      labels: [],
      datasets: [{
        label: "Emails per Hour",
        data: [],
        borderColor: "blue",
        fill: false
      }]
    }
  }
);

function updateTimeChart() {
  const hourMap = {};
  emails.forEach(e => {
    if (!e.time) return;
    const hour = e.time.slice(0, 13);
    hourMap[hour] = (hourMap[hour] || 0) + 1;
  });
  timeChart.data.labels = Object.keys(hourMap);
  timeChart.data.datasets[0].data = Object.values(hourMap);
  timeChart.update();
}

/* ===== UI Update ===== */
function updateUI() {
  document.getElementById("totalEmails").innerText = emails.length;
  document.getElementById("queuedCount").innerText =
    emails.filter(e => e.status === "Queued").length;
  document.getElementById("lowPriority").innerText =
    emails.filter(e => e.priority === "LOW").length;

  const query = document.getElementById("searchBox").value.toLowerCase();
  const tbody = document.getElementById("emailTable");
  tbody.innerHTML = "";

  emails
    .filter(e =>
      e.from?.toLowerCase().includes(query) ||
      e.subject?.toLowerCase().includes(query)
    )
    .slice().reverse()
    .forEach(e => {
      tbody.insertAdjacentHTML("beforeend", `
        <tr>
          <td>${e.from || "-"}</td>
          <td>${e.subject || "-"}</td>
          <td>${e.priority || "-"}</td>
          <td class="status ${e.status}">${e.status}</td>
          <td>${e.time || "-"}</td>
        </tr>
      `);
    });

  priorityChart.data.datasets[0].data = [
    priorityCount.HIGH,
    priorityCount.MEDIUM,
    priorityCount.LOW
  ];
  priorityChart.update();

  updateTimeChart();
}

/* ===== CSV ===== */
function downloadCSV() {
  let csv = "From,Subject,Priority,Status,Time\n";
  emails.forEach(e => {
    csv += `"${e.from}","${e.subject}","${e.priority}","${e.status}","${e.time}"\n`;
  });
  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "email_logs.csv";
  a.click();
}

/* ===== Dark Mode ===== */
function toggleDarkMode() {
  document.body.classList.toggle("dark");
}

/* ===== Initial Load ===== */
fetch("/api/data")
  .then(res => res.json())
  .then(data => {
    emails = data;
    priorityCount = { HIGH: 0, MEDIUM: 0, LOW: 0 };
    data.forEach(e => { if (e.priority) priorityCount[e.priority]++; });
    updateUI();
  });

/* ===== Live Updates ===== */
socket.on("email_update", data => {
  emails.push(data);
  if (data.priority) priorityCount[data.priority]++;
  updateUI();
});

socket.on("status_update", data => {
  const i = emails.findIndex(e => e.reply_id === data.reply_id);
  if (i !== -1) emails[i] = data;
  updateUI();
});
</script>

</body>
</html>
